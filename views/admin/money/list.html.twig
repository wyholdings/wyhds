{% extends 'admin/layout/base.html.twig' %}

{% block content %}
<style>
select.form-select-sm {
  padding: 0.25rem 0.5rem;
  font-size: 0.875rem;
  height: auto;
}
</style>
<div class="container-fluid w-75 mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
    <h3>{{ member_name_text }} {{ type }} 내역</h3>
    <form method="get" class="ms-2">
        <input type="hidden" name="member_name" value="{{ member_name }}">
        <input type="hidden" name="type" value="{{ type }}">
        <div class="d-flex gap-2 align-items-center">
            <select name="year" class="form-select form-select-sm" style="min-width: 100px;" onchange="this.form.submit()">
            {% for y in years %}
                <option value="{{ y }}" {{ y == year ? 'selected' : '' }}>{{ y }}년</option>
            {% endfor %}
            </select>
            <select name="period" class="form-select form-select-sm" style="min-width: 110px;" onchange="this.form.submit()">
                <option value="year" {{ period == 'year' ? 'selected' : '' }}>연간</option>
                <option value="half" {{ period == 'half' ? 'selected' : '' }}>반기</option>
                <option value="month" {{ period == 'month' ? 'selected' : '' }}>월간</option>
            </select>
            <select name="half" class="form-select form-select-sm {{ period != 'half' ? 'd-none' : '' }}" style="min-width: 110px;" onchange="this.form.submit()">
            {% for h in halves %}
                <option value="{{ h }}" {{ h == half ? 'selected' : '' }}>{{ h == 1 ? '상반기' : '하반기' }}</option>
            {% endfor %}
            </select>
            <select name="month" class="form-select form-select-sm {{ period != 'month' ? 'd-none' : '' }}" style="min-width: 90px;" onchange="this.form.submit()">
            {% for m in months %}
                <option value="{{ m }}" {{ m == month ? 'selected' : '' }}>{{ m }}월</option>
            {% endfor %}
            </select>
        </div>
    </form>
    <div class="d-flex gap-2 align-items-center">
        <div class="btn-group">
            <a href="?member_name={{ member_name }}&type=수입&year={{ year }}&period={{ period }}{% if period == 'month' %}&month={{ month }}{% elseif period == 'half' %}&half={{ half }}{% endif %}" class="btn btn-outline-primary {{ type == '수입' ? 'active' : '' }}">수입</a>
            <a href="?member_name={{ member_name }}&type=지출&year={{ year }}&period={{ period }}{% if period == 'month' %}&month={{ month }}{% elseif period == 'half' %}&half={{ half }}{% endif %}" class="btn btn-outline-danger {{ type == '지출' ? 'active' : '' }}">지출</a>
        </div>
    </div>
</div>

<div class="card mb-4">
    <div class="card-body py-3">
        <div class="d-flex justify-content-between align-items-center">
            <strong>통계표 ({{ period_label }})</strong>
        </div>
        <div class="table-responsive mt-2">
            <table class="table table-sm table-bordered mb-0">
                <thead class="table-light">
                    <tr>
                        <th style="width: 120px;">건수</th>
                        <th style="width: 160px;">금액 합계</th>
                        <th style="width: 160px;">부가세 합계</th>
                        <th style="width: 160px;">총합계</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>{{ total_money.row_count|default(0) }}</td>
                        <td>{{ total_money.amount_sum|default(0)|number_format }}</td>
                        <td>{{ total_money.vat_sum|default(0)|number_format }}</td>
                        <td>{{ total_money.total_sum|default(0)|number_format }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<button class="btn btn-success mb-3" id="toggle-form-btn">+ 항목 추가</button>

{# 입력 폼 영역 (ajax + hidden) #}
<div id="entry-form" class="card p-3 mb-4" style="display:none;">
    <form id="account-form">
    <input type="hidden" name="id" id="edit-id" value="">
    <input type="hidden" name="member_name" value="{{ member_name }}">
    <input type="hidden" name="type" value="{{ type }}">
    <div class="row g-2">
        <div class="col-md-2">
        <input type="number" name="amount" id="form-amount" class="form-control" placeholder="금액" required>
        </div>
        <div class="col-md-2">
        <input type="number" name="vat" id="form-vat" class="form-control" placeholder="부가세" value="0">
        </div>
        <div class="col-md-2">
        <input type="date" name="date" id="form-date" class="form-control" required>
        </div>
        <div class="col-md-2">
        <input type="text" name="company" id="form-company" class="form-control" placeholder="업체명">
        </div>
        <div class="col-md-2">
        <input type="text" name="product" id="form-product" class="form-control" placeholder="품목명">
        </div>
        <div class="col-md-2">
        <div class="d-flex gap-2">
            <button type="submit" id="form-submit-btn" class="btn btn-primary w-100">저장</button>
            <button type="button" id="form-cancel-btn" class="btn btn-outline-secondary w-100" style="display:none;">취소</button>
        </div>
        </div>
    </div>
    </form>
</div>

<table class="table table-bordered table-striped">
    <thead class="table-light">
    <tr>
        <th>날짜</th><th>금액</th><th>부가세</th><th>총금액</th><th>업체</th><th>품목</th><th>수정</th><th>삭제</th>
    </tr>
    </thead>
    <tbody id="account-list">
    {% for item in monies %}
        <tr
            data-id="{{ item.id }}"
            data-date="{{ item.date|e('html_attr') }}"
            data-amount="{{ item.amount }}"
            data-vat="{{ item.vat }}"
            data-company="{{ item.company|default('')|e('html_attr') }}"
            data-product="{{ item.product|default('')|e('html_attr') }}"
        >
        <td>{{ item.date }}</td>
        <td>{{ item.amount|number_format }}</td>
        <td>{{ item.vat|number_format }}</td>
        <td>{{ (item.amount + item.vat)|number_format }}</td>
        <td>{{ item.company }}</td>
        <td>{{ item.product }}</td>
        <td>
            <button class="btn btn-sm btn-outline-primary edit-btn" data-id="{{ item.id }}">수정</button>
        </td>
        <td>
            <button class="btn btn-sm btn-danger delete-btn" data-id="{{ item.id }}">삭제</button>
        </td>
        </tr>
    {% endfor %}
    </tbody>
    <tfoot class="table-warning">
    <tr>
        <td><strong>총합계</strong></td>
        <td><strong>{{ total_money.amount_sum|number_format }}</strong></td>
        <td><strong>{{ total_money.vat_sum|number_format }}</strong></td>
        <td><strong>{{ total_money.total_sum|number_format }}</strong></td>
        <td></td>
        <td></td>
        <td></td>
        <td></td>
    </tr>
    </tfoot>
</table>
</div>

<script>
const toggleBtn = document.getElementById('toggle-form-btn');
const entryForm = document.getElementById('entry-form');
const accountForm = document.getElementById('account-form');
const editIdInput = document.getElementById('edit-id');
const submitBtn = document.getElementById('form-submit-btn');
const cancelBtn = document.getElementById('form-cancel-btn');

function setAddMode() {
    editIdInput.value = '';
    submitBtn.textContent = '저장';
    cancelBtn.style.display = 'none';
    toggleBtn.textContent = '+ 항목 추가';
}

function setEditMode(row) {
    editIdInput.value = row.dataset.id || '';
    document.getElementById('form-date').value = row.dataset.date || '';
    document.getElementById('form-amount').value = row.dataset.amount || '';
    document.getElementById('form-vat').value = row.dataset.vat || '0';
    document.getElementById('form-company').value = row.dataset.company || '';
    document.getElementById('form-product').value = row.dataset.product || '';
    submitBtn.textContent = '수정 저장';
    cancelBtn.style.display = 'inline-block';
    entryForm.style.display = 'block';
    toggleBtn.textContent = '수정 중';
    window.scrollTo({ top: entryForm.offsetTop - 80, behavior: 'smooth' });
}

toggleBtn.addEventListener('click', () => {
    if (entryForm.style.display === 'none') {
        entryForm.style.display = 'block';
    } else {
        entryForm.style.display = 'none';
        accountForm.reset();
        setAddMode();
    }
});

cancelBtn.addEventListener('click', () => {
    accountForm.reset();
    setAddMode();
});

    accountForm.addEventListener('submit', async function (e) {
    e.preventDefault();

    const formData = new FormData(this);
    const editId = editIdInput.value;
    const endpoint = editId ? '/admin/money/update' : '/admin/money/add';

    const response = await fetch(endpoint, {
        method: 'POST',
        body: formData
    });

    const result = await response.json();

    if (result.success) {
        this.reset();
        setAddMode();
        location.reload();
    } else {
        alert('저장 실패: ' + result.message);
    }
});

document.querySelectorAll('.edit-btn').forEach(button => {
  button.addEventListener('click', function () {
    const id = this.dataset.id;
    const row = document.querySelector(`tr[data-id="${id}"]`);
    if (!row) return;
    setEditMode(row);
  });
});

document.querySelectorAll('.delete-btn').forEach(button => {
  button.addEventListener('click', async function () {
    if (!confirm('정말 삭제하시겠습니까?')) return;

    const id = this.dataset.id;

    const response = await fetch('/admin/money/delete', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: `id=${id}`
    });

    const result = await response.json();

    if (result.success) {
      document.querySelector(`tr[data-id="${id}"]`).remove();
    } else {
      alert('삭제 실패: ' + result.message);
    }
  });
});

setAddMode();
</script>


{% endblock %}
